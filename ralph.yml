cli:
  backend: "claude"

event_loop:
  completion_promise: "LOOP_COMPLETE"
  max_iterations: 50
  prompt_file: "PROMPT.md"
  starting_event: "work.start"
  checkpoint_interval: 1

core:
  scratchpad: ".agent/scratchpad.md"
  specs_dir: "./specs/"

hats:
  git_setup:
    name: "Git Setup"
    description: |
      Git/GitHub初期化。既にセットアップ済みなら確認のみ。失敗したら即LOOP_COMPLETE。

      実行手順:
      1. gh auth status (認証確認、失敗→LOOP_COMPLETE)
      2. git status で状態確認
      3. remoteが設定されていなければ: gh repo view で確認後、origin設定
      4. git push origin main で同期確認

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push (変更があれば)

      全て成功 → git.ready / いずれか失敗 → LOOP_COMPLETE
    triggers:
      - "work.start"
    publishes:
      - "git.ready"
      - "LOOP_COMPLETE"

  architect:
    name: "Architect"
    description: |
      Phase 1-3 の設計・API仕様策定。

      タスク:
      1. docs/TECHNICAL_DESIGN.md を精読
      2. 未実装のPhase 1, 2, 3 のタスクを specs/ に詳細仕様として書き出す
      3. Worker側とPages側で分担できるよう整理

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Architect: Phase 1-3 specs" && git push

      両方のイベントを発行 → specs.ready.worker, specs.ready.pages
    triggers:
      - "git.ready"
    publishes:
      - "specs.ready.worker"
      - "specs.ready.pages"

  worker_dev:
    name: "Worker Developer"
    description: |
      Cloudflare Worker (バックエンド) の実装。

      担当範囲:
      - worker/ 配下のTypeScriptコード
      - Cron Trigger (scheduled)
      - API endpoints (/api/sample, /api/preview, /api/checkout, /api/webhook/stripe)
      - D1/R2 連携

      実装順序:
      1. Phase 1: Cron + サンプル生成 + R2保存
      2. Phase 2: POST /api/preview 実装
      3. Phase 3: Stripe Checkout + Webhook

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Worker: {完了内容}" && git push
    triggers:
      - "specs.ready.worker"
      - "review.worker.changes"
    publishes:
      - "worker.done"

  pages_dev:
    name: "Pages Developer"
    description: |
      Cloudflare Pages (フロントエンド) の実装。

      担当範囲:
      - pages/public/ 配下のHTML/CSS/JS
      - サンプル表示UI
      - プレビュー表示
      - 購入ボタン → Checkout リダイレクト
      - 成功/キャンセル画面

      実装順序:
      1. Phase 1: 最新サンプル表示
      2. Phase 2: プレビュー生成・表示
      3. Phase 3: 購入フロー完結

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Pages: {完了内容}" && git push
    triggers:
      - "specs.ready.pages"
      - "review.pages.changes"
    publishes:
      - "pages.done"

  integrator:
    name: "Integrator"
    description: |
      Worker + Pages の統合テスト、動作確認、最終レビュー。

      チェック項目:
      1. Worker API が正しく動作するか (npm run dev でローカル起動)
      2. Pages から Worker への通信が正しいか
      3. 各Phaseの完了条件を満たしているか
      4. TypeScriptのエラーがないか (npm run build)

      判定:
      - 問題あり → review.worker.changes または review.pages.changes
      - 全Phase完了 → LOOP_COMPLETE発行

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push

      LOOP_COMPLETE発行時は追加で:
      3. COMPLETION_REPORT.md を生成
      4. 最終 git push
    triggers:
      - "worker.done"
      - "pages.done"
    publishes:
      - "review.worker.changes"
      - "review.pages.changes"
      - "LOOP_COMPLETE"
