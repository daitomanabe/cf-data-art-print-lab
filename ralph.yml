cli:
  backend: "claude"

event_loop:
  completion_promise: "LOOP_COMPLETE"
  max_iterations: 60
  prompt_file: "PROMPT.md"
  starting_event: "work.start"
  checkpoint_interval: 1

core:
  scratchpad: ".agent/scratchpad.md"
  specs_dir: "./specs/"

hats:
  git_setup:
    name: "Git Setup"
    description: |
      Git/GitHub同期確認。失敗したら即LOOP_COMPLETE。

      実行手順:
      1. gh auth status (認証確認)
      2. git pull origin main (最新取得)
      3. git status で状態確認

      完了後:
      1. .agent/iteration.log に記録
      2. git push (変更があれば)

      全て成功 → git.ready / 失敗 → LOOP_COMPLETE
    triggers:
      - "work.start"
    publishes:
      - "git.ready"
      - "LOOP_COMPLETE"

  analyst:
    name: "Code Analyst"
    description: |
      現状分析と改善計画策定。

      タスク:
      1. worker/src/ のコード品質確認
         - TypeScript エラー (npm run build)
         - エラーハンドリングの抜け
         - 入力バリデーション不足
      2. pages/public/ のUI確認
         - ローディング状態の有無
         - エラー表示の有無
      3. テストの有無確認
      4. Phase 4要件との差分確認

      成果物:
      - specs/refinement-plan.md に改善計画を記載

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Analyst: Refinement plan" && git push

      → analysis.ready.worker, analysis.ready.pages, analysis.ready.admin
    triggers:
      - "git.ready"
    publishes:
      - "analysis.ready.worker"
      - "analysis.ready.pages"
      - "analysis.ready.admin"

  worker_refiner:
    name: "Worker Refiner"
    description: |
      Workerコードの品質向上。

      改善項目:
      1. エラーハンドリング強化
         - try-catch の適切な配置
         - エラーレスポンスの統一
      2. 入力バリデーション
         - リクエストボディの検証
         - パラメータの型チェック
      3. ログ出力の追加
         - console.log/error の適切な配置
      4. TypeScript strict オプション検討

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Worker: {改善内容}" && git push
    triggers:
      - "analysis.ready.worker"
      - "review.worker.changes"
    publishes:
      - "worker.refined"

  pages_refiner:
    name: "Pages Refiner"
    description: |
      フロントエンドUI/UXの改善。

      改善項目:
      1. ローディング状態
         - ボタン押下時のスピナー
         - API待機中の表示
      2. エラーハンドリング
         - fetch失敗時のユーザーフィードバック
         - リトライ機能
      3. UX改善
         - ボタンのdisabled状態管理
         - 成功/失敗のトースト表示
      4. アクセシビリティ
         - aria属性の追加

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Pages: {改善内容}" && git push
    triggers:
      - "analysis.ready.pages"
      - "review.pages.changes"
    publishes:
      - "pages.refined"

  admin_builder:
    name: "Admin Builder"
    description: |
      Phase 4: 管理機能の実装。

      実装項目:
      1. GET /api/admin/orders - 注文一覧API
         - ステータスフィルタ (DRAFT, PAID, SHIPPED)
         - 簡易認証 (Bearer token / 環境変数)
      2. GET /art/masters/:id - マスターファイルダウンロード
         - 管理者のみアクセス可
      3. pages/public/admin.html - 簡易管理画面
         - 注文一覧表示
         - マスターダウンロードリンク

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Admin: {実装内容}" && git push
    triggers:
      - "analysis.ready.admin"
      - "review.admin.changes"
    publishes:
      - "admin.done"

  doc_updater:
    name: "Documentation Updater"
    description: |
      ドキュメント更新。

      タスク:
      1. docs/IMPLEMENTATION_ROADMAP.md
         - Phase 1-3 を完了済みに更新
         - Phase 4 の進捗反映
      2. README.md
         - 管理機能の説明追加
         - 環境変数の追加説明
      3. worker/README.md
         - 新APIエンドポイントの説明

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit -m "[Ralph] Docs: Updated for refinement" && git push
    triggers:
      - "worker.refined"
      - "pages.refined"
      - "admin.done"
    publishes:
      - "docs.updated"

  integrator:
    name: "Integrator"
    description: |
      統合テスト、最終確認。

      チェック項目:
      1. TypeScript ビルド成功 (cd worker && npm run build)
      2. 全APIエンドポイントの動作確認
      3. フロントエンドの表示確認
      4. 管理機能の動作確認
      5. ドキュメントの整合性

      判定:
      - Worker問題 → review.worker.changes
      - Pages問題 → review.pages.changes
      - Admin問題 → review.admin.changes
      - 全完了 → LOOP_COMPLETE発行

      完了後:
      1. .agent/iteration.log に記録
      2. git add -A && git commit && git push

      LOOP_COMPLETE発行時:
      3. COMPLETION_REPORT.md を生成
      4. 最終 git push
    triggers:
      - "docs.updated"
    publishes:
      - "review.worker.changes"
      - "review.pages.changes"
      - "review.admin.changes"
      - "LOOP_COMPLETE"
