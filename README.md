# cf-data-art-print-lab

Cloudflareï¼ˆPages + Workers + D1 + R2ï¼‰ã§å‹•ãã€Œãƒ‡ãƒ¼ã‚¿â†’ä½œå“â†’è³¼å…¥â†’é¡è£…ãƒ—ãƒªãƒ³ãƒˆç™ºé€ã€ã¾ã§ã®å®Ÿé¨“ç”¨ãƒªãƒã‚¸ãƒˆãƒªã€‚

**ç›®çš„ã¯"å£²ä¸Š"ã§ã¯ãªãã€"å‹•ãå®Ÿé¨“"ã‚’å…¬é–‹ã™ã‚‹ã“ã¨ã€‚**
ã ã‹ã‚‰æœ€åˆã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¦‹ã‚‹ã¨è‡ªå‹•ï¼è£å´ã¯æ‰‹å‹•ã§ã‚‚OKã€ã‚’å‰æã«ã€æœ€å°æ§‹æˆã§ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã‚’é€šã™ã€‚

---

## é€²æ—çŠ¶æ³

| Phase | å†…å®¹ | çŠ¶æ…‹ |
|-------|------|------|
| 0 | ãƒªãƒã‚¸ãƒˆãƒªéª¨æ ¼ | âœ… Done |
| 1 | 1æ™‚é–“ã”ã¨ã®ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆ | âœ… Done |
| 2 | è³¼å…¥ã‚¯ãƒªãƒƒã‚¯â†’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ | âœ… Done |
| 3 | Stripe Checkoutï¼ˆãƒ†ã‚¹ãƒˆï¼‰ | âœ… Done |
| 4 | æ‰‹å‹•ãƒ•ãƒ«ãƒ•ã‚£ãƒ«ãƒ¡ãƒ³ãƒˆ | ğŸš§ Next |
| 5 | Gelatoè‡ªå‹•ç™ºæ³¨ | ğŸ“‹ Planned |
| 6 | å®Ÿãƒ‡ãƒ¼ã‚¿å°å…¥ | ğŸ“‹ Planned |

---

## ã§ãã‚‹ã“ã¨ï¼ˆMVPï¼‰

- **1æ™‚é–“ã”ã¨**ã«ã‚µãƒ³ãƒ—ãƒ«ä½œå“ï¼ˆSVGï¼‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã€ã‚µã‚¤ãƒˆã«è¡¨ç¤º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œè³¼å…¥ã€å°ç·šã‚’æŠ¼ã™ã¨ã€**ãã®ç¬é–“ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿**ã§ä½œå“ã‚’ç”Ÿæˆã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
- OKãªã‚‰ **Stripe Checkout** ã«é£›ã‚“ã§æ±ºæ¸ˆï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
- æ±ºæ¸ˆå®Œäº†Webhookã‚’å—ã‘ã¦æ³¨æ–‡ã‚’ `PAID` ã«æ›´æ–°

**Phase 5ä»¥é™**: Gelato APIã§é¡è£…ãƒ—ãƒªãƒ³ãƒˆã‚’è‡ªå‹•ç™ºæ³¨

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
[Browser]
  |
  v
[Cloudflare Pages] --- fetch ---> [Cloudflare Worker API]
                                   |   |      |      |
                                   |   |      |      +--> Gelatoï¼ˆPODï¼‰[Phase 5]
                                   |   |      |
                                   |   |      +--> Stripeï¼ˆæ±ºæ¸ˆï¼‰
                                   |   |
                                   |   +--> D1ï¼ˆçŠ¶æ…‹ï¼‰
                                   |
                                   +--> R2ï¼ˆä½œå“ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
```

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ç”¨é€” |
|---------------|------|
| Cloudflare Pages | ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤ºã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€è³¼å…¥å°ç·šï¼‰ |
| Cloudflare Workers | APIãƒ»Cronãƒ»Stripeé€£æºãƒ»R2é…ä¿¡ |
| Cloudflare D1 | ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ä½œå“ï¼æ³¨æ–‡ï¼ãƒã‚¤ãƒ³ã‚¿ç®¡ç† |
| Cloudflare R2 | ç”Ÿæˆã—ãŸä½œå“ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆSVG / å°†æ¥PDFï¼‰ |
| Stripe | æ±ºæ¸ˆ |
| Gelato | é¡è£…ãƒ—ãƒªãƒ³ãƒˆï¼ˆPODï¼‰[Phase 5] |

---

## å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹

### å¿…é ˆ

| ã‚µãƒ¼ãƒ“ã‚¹ | ç™»éŒ²URL | å–å¾—ã™ã‚‹ã‚‚ã® |
|----------|---------|--------------|
| **Cloudflare** | https://dash.cloudflare.com/sign-up | Workers, Pages, D1, R2 |
| **Stripe** | https://dashboard.stripe.com/register | `sk_test_xxx`, `whsec_xxx` |

### Phase 5ï¼ˆGelatoè‡ªå‹•ç™ºæ³¨ï¼‰

| ã‚µãƒ¼ãƒ“ã‚¹ | ç™»éŒ²URL | å–å¾—ã™ã‚‹ã‚‚ã® |
|----------|---------|--------------|
| **Gelato** | https://www.gelato.com/ja | APIã‚­ãƒ¼ |

Gelatoé¸å®šç†ç”±:
- ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªå¯¾å¿œï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ã‚µãƒãƒ¼ãƒˆï¼‰
- ğŸ¨ ãƒ•ã‚¡ã‚¤ãƒ³ã‚¢ãƒ¼ãƒˆå°åˆ·ï¼ˆã‚¸ã‚¯ãƒ¬ãƒ¼ï¼‰å¯¾å¿œ
- ğŸšš æ—¥æœ¬ç¾åœ°ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆé…é€2-5æ—¥ï¼‰
- ğŸŒ 32ãƒµå›½140+ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼

---

## ãƒªãƒã‚¸ãƒˆãƒªæ§‹æˆ

```
.
â”œâ”€ docs/
â”‚  â”œâ”€ OVERVIEW.md                 # æ¦‚è¦
â”‚  â”œâ”€ TECHNICAL_DESIGN.md         # æŠ€è¡“è¨­è¨ˆæ›¸
â”‚  â””â”€ IMPLEMENTATION_ROADMAP.md   # å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—
â”œâ”€ worker/                        # Cloudflare Workersï¼ˆAPI + Cronï¼‰
â”‚  â””â”€ src/
â”‚     â”œâ”€ routes/                  # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚     â”œâ”€ pod/                     # PODé€£æºï¼ˆGelatoï¼‰
â”‚     â”œâ”€ db/                      # D1ã‚¯ã‚¨ãƒª
â”‚     â””â”€ artwork/                 # ä½œå“ç”Ÿæˆ
â””â”€ pages/                         # Cloudflare Pagesï¼ˆé™çš„ãƒ•ãƒ­ãƒ³ãƒˆï¼‰
   â””â”€ public/
```

---

## ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•

### 1) Cloudflare ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

```bash
# D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
wrangler d1 create cf_data_art_print_db
# â†’ å‡ºåŠ›ã•ã‚ŒãŸ database_id ã‚’ãƒ¡ãƒ¢

# R2ãƒã‚±ãƒƒãƒˆä½œæˆ
wrangler r2 bucket create cf-data-art-print-artifacts
```

### 2) Worker

```bash
cd worker

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm i

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .dev.vars.example .dev.vars
# .dev.vars ã‚’ç·¨é›†:
#   - STRIPE_SECRET_KEY
#   - STRIPE_WEBHOOK_SECRET

# wrangler.toml ã® database_id ã‚’æ›´æ–°

# DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npm run db:migrate:local

# èµ·å‹•
npm run dev
# â†’ http://localhost:8787
```

### 3) Pagesï¼ˆãƒ•ãƒ­ãƒ³ãƒˆï¼‰

```bash
cd pages

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cp public/config.example.js public/config.js
# config.js ã® workerBaseUrl ã‚’ http://localhost:8787 ã«

# ç°¡æ˜“ã‚µãƒ¼ãƒèµ·å‹•
npx serve public -l 8788
# â†’ http://localhost:8788
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤

### Worker

```bash
cd worker

# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
wrangler secret put STRIPE_SECRET_KEY
wrangler secret put STRIPE_WEBHOOK_SECRET

# DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœ¬ç•ªï¼‰
npm run db:migrate

# ãƒ‡ãƒ—ãƒ­ã‚¤
npm run deploy
```

### Pages

- Cloudflare Pages ã§ GitHub ãƒªãƒã‚¸ãƒˆãƒªã‚’æ¥ç¶š
- ãƒ“ãƒ«ãƒ‰è¨­å®š: ãªã—ï¼ˆé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- å…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: `pages/public`

---

## API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ |
|---------------|------|
| `GET /api/health` | æ­»æ´»ç¢ºèª |
| `GET /api/sample/latest` | æœ€æ–°ã‚µãƒ³ãƒ—ãƒ«æƒ…å ± |
| `POST /api/preview` | ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œå“ç”Ÿæˆ |
| `POST /api/checkout` | Stripe Checkoutä½œæˆ |
| `POST /api/webhook/stripe` | Stripe Webhook |
| `GET /art/<key>` | ä½œå“ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ |
| `GET /api/admin/orders` | æ³¨æ–‡ä¸€è¦§ï¼ˆPhase 4ã€è¦èªè¨¼ï¼‰ |

è©³ç´°ã¯ `docs/TECHNICAL_DESIGN.md` ã‚’å‚ç…§ã€‚

---

## æ³¨æ„ç‚¹

- ã€Œ1æ™‚é–“ã”ã¨ã«ã‚µãƒ³ãƒ—ãƒ«ã€ã¯ç°¡å˜ã€‚ã§ã‚‚ã€Œå°åˆ·ç”¨ãƒã‚¹ã‚¿ãƒ¼ï¼ˆPDF/è§£åƒåº¦/ä½™ç™½/è‰²ï¼‰ã€ã¯ä¸€æ°—ã«é›£ã—ããªã‚‹ã€‚
  **MVPã¯SVGã§é€šã—ã¦ã€æ¬¡ã«PDFç”Ÿæˆã«é€²ã‚ã€‚**
- Stripeã®Webhookç½²åæ¤œè¨¼ã‚’é›‘ã«ã™ã‚‹ã¨ã€æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå£Šã‚Œã‚‹ã€‚
  **ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…ã¯"æœ€å°ã®éª¨æ ¼"ã€‚æœ¬ç•ªé‹ç”¨ã™ã‚‹ãªã‚‰è¦ç›£æŸ»ã€‚**
- é¡è£…PODã¯ä»•æ§˜ï¼ˆã‚µã‚¤ã‚ºï¼ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ç´™ï¼ä½™ç™½ï¼‰ã§ç‚ä¸Šã—ãŒã¡ã€‚
  **Gelatoã®ä»•æ§˜ã‚’ç¢ºèªã—ã¦ã‹ã‚‰è‡ªå‹•åŒ–ã€‚æœ€åˆã¯æ‰‹å‹•ã§å“è³ªã‚’æ´ã‚ã€‚**

---

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT - `LICENSE` ã‚’å‚ç…§ã€‚
